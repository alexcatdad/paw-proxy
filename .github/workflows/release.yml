# .github/workflows/release.yml
#
# Automatic release on merge to main.
# Parses conventional commits since the last tag to determine semver bump:
#   - "feat:" -> minor
#   - "fix:", "perf:", "refactor:" -> patch
#   - "!:" or "BREAKING CHANGE" -> major
#   - "docs:", "ci:", "chore:", "test:", "style:" -> skip (no release)
#
# Tags the commit, builds universal macOS binaries, and publishes a GitHub release.

name: Release

on:
  push:
    branches: [main]
    tags: ['v*']

permissions:
  contents: write

jobs:
  release:
    runs-on: macos-14
    # Skip if this push was the bot creating a tag (avoid double-run)
    if: github.actor != 'github-actions[bot]' || !startsWith(github.ref, 'refs/tags/')
    outputs:
      tag: ${{ steps.version.outputs.tag }}
      released: ${{ steps.version.outputs.skip != 'true' }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version
        id: version
        env:
          HEAD_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          # If triggered by a tag push, use the tag directly
          if [[ "$GITHUB_REF" == refs/tags/v* ]]; then
            echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
            echo "skip=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Skip non-release commits
          if echo "$HEAD_MESSAGE" | head -1 | grep -qE '^(docs|ci|chore|test|style)(\(.+\))?:'; then
            echo "Non-release commit type. Skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Get the latest tag
          LATEST_TAG=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.0.0"
          fi

          # Parse current version
          VERSION="${LATEST_TAG#v}"
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Get commits since last tag
          COMMITS=$(git log "$LATEST_TAG"..HEAD --pretty=format:"%s" 2>/dev/null || git log --pretty=format:"%s")
          echo "Commits since $LATEST_TAG:"
          echo "$COMMITS"

          # Determine bump type
          BUMP="none"
          while IFS= read -r msg; do
            if echo "$msg" | grep -qE '^[a-z]+(\(.+\))?!:' || echo "$msg" | grep -qi 'BREAKING CHANGE'; then
              BUMP="major"
              break
            fi
            if echo "$msg" | grep -qE '^feat(\(.+\))?:'; then
              [ "$BUMP" != "major" ] && BUMP="minor"
            fi
            if echo "$msg" | grep -qE '^(fix|perf|refactor)(\(.+\))?:'; then
              [ "$BUMP" = "none" ] && BUMP="patch"
            fi
          done <<< "$COMMITS"

          if [ "$BUMP" = "none" ]; then
            echo "No version-bumping commits found. Skipping."
            echo "skip=true" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          case "$BUMP" in
            major) MAJOR=$((MAJOR + 1)); MINOR=0; PATCH=0 ;;
            minor) MINOR=$((MINOR + 1)); PATCH=0 ;;
            patch) PATCH=$((PATCH + 1)) ;;
          esac

          NEW_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          echo "tag=$NEW_TAG" >> "$GITHUB_OUTPUT"
          echo "skip=false" >> "$GITHUB_OUTPUT"
          echo "Bumping $BUMP: $LATEST_TAG -> $NEW_TAG"

      - name: Create tag
        if: steps.version.outputs.skip != 'true' && !startsWith(github.ref, 'refs/tags/')
        env:
          NEW_TAG: ${{ steps.version.outputs.tag }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$NEW_TAG" -m "Release $NEW_TAG"
          git push origin "$NEW_TAG"

      - uses: actions/setup-go@v5
        if: steps.version.outputs.skip != 'true'
        with:
          go-version: '1.24.13'

      - name: Run tests
        if: steps.version.outputs.skip != 'true'
        run: go test -v -race ./...

      - name: Check vulnerabilities
        if: steps.version.outputs.skip != 'true'
        run: go run golang.org/x/vuln/cmd/govulncheck@latest ./...

      - name: Build binaries
        if: steps.version.outputs.skip != 'true'
        env:
          VERSION: ${{ steps.version.outputs.tag }}
        run: |
          mkdir -p dist
          LDFLAGS="-s -w -X main.version=${VERSION} -X github.com/alexcatdad/paw-proxy/internal/api.Version=${VERSION}"

          # paw-proxy
          GOOS=darwin GOARCH=arm64 go build -ldflags="$LDFLAGS" -o dist/paw-proxy-darwin-arm64 ./cmd/paw-proxy
          GOOS=darwin GOARCH=amd64 go build -ldflags="$LDFLAGS" -o dist/paw-proxy-darwin-amd64 ./cmd/paw-proxy
          lipo -create -output dist/paw-proxy-darwin-universal dist/paw-proxy-darwin-arm64 dist/paw-proxy-darwin-amd64

          # up
          GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w" -o dist/up-darwin-arm64 ./cmd/up
          GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w" -o dist/up-darwin-amd64 ./cmd/up
          lipo -create -output dist/up-darwin-universal dist/up-darwin-arm64 dist/up-darwin-amd64

          # Checksums
          (cd dist && shasum -a 256 paw-proxy-darwin-arm64 paw-proxy-darwin-amd64 paw-proxy-darwin-universal up-darwin-arm64 up-darwin-amd64 up-darwin-universal > checksums.txt)

      - name: Create release
        if: steps.version.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          files: |
            dist/paw-proxy-darwin-arm64
            dist/paw-proxy-darwin-amd64
            dist/paw-proxy-darwin-universal
            dist/up-darwin-arm64
            dist/up-darwin-amd64
            dist/up-darwin-universal
            dist/checksums.txt
          generate_release_notes: true

  update-homebrew:
    name: Update Homebrew Tap
    runs-on: ubuntu-latest
    needs: release
    if: needs.release.outputs.released == 'true'
    environment: action-runners
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ vars.APP_ID }}
          private-key: ${{ secrets.APP_SECRET }}
          owner: ${{ github.repository_owner }}
          repositories: homebrew-tap

      - name: Get GitHub App user ID
        id: get-user-id
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"

      - name: Download release binaries
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ needs.release.outputs.tag }}
        run: gh release download "$TAG" --repo "${{ github.repository }}" --pattern 'paw-proxy-darwin-*' --pattern 'up-darwin-*' --dir assets

      - name: Compute SHA256 checksums
        id: sha
        run: |
          echo "proxy_arm64=$(sha256sum assets/paw-proxy-darwin-arm64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "proxy_amd64=$(sha256sum assets/paw-proxy-darwin-amd64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "up_arm64=$(sha256sum assets/up-darwin-arm64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"
          echo "up_amd64=$(sha256sum assets/up-darwin-amd64 | cut -d' ' -f1)" >> "$GITHUB_OUTPUT"

      - name: Checkout homebrew-tap
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/homebrew-tap
          token: ${{ steps.app-token.outputs.token }}

      - name: Strip version prefix
        id: ver
        env:
          TAG: ${{ needs.release.outputs.tag }}
        run: echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"

      - name: Update formula
        env:
          VERSION: ${{ steps.ver.outputs.version }}
          SHA_PROXY_ARM64: ${{ steps.sha.outputs.proxy_arm64 }}
          SHA_PROXY_AMD64: ${{ steps.sha.outputs.proxy_amd64 }}
          SHA_UP_ARM64: ${{ steps.sha.outputs.up_arm64 }}
          SHA_UP_AMD64: ${{ steps.sha.outputs.up_amd64 }}
        run: |
          cat > Formula/paw-proxy.rb << 'FORMULA'
          class PawProxy < Formula
            desc "Zero-config HTTPS proxy for local macOS development"
            homepage "https://github.com/alexcatdad/paw-proxy"
            license "MIT"
          FORMULA

          cat >> Formula/paw-proxy.rb << EOF
            version "${VERSION}"

            on_macos do
              on_arm do
                url "https://github.com/alexcatdad/paw-proxy/releases/download/v${VERSION}/paw-proxy-darwin-arm64"
                sha256 "${SHA_PROXY_ARM64}"

                resource "up" do
                  url "https://github.com/alexcatdad/paw-proxy/releases/download/v${VERSION}/up-darwin-arm64"
                  sha256 "${SHA_UP_ARM64}"
                end
              end

              on_intel do
                url "https://github.com/alexcatdad/paw-proxy/releases/download/v${VERSION}/paw-proxy-darwin-amd64"
                sha256 "${SHA_PROXY_AMD64}"

                resource "up" do
                  url "https://github.com/alexcatdad/paw-proxy/releases/download/v${VERSION}/up-darwin-amd64"
                  sha256 "${SHA_UP_AMD64}"
                end
              end
            end
          EOF

          cat >> Formula/paw-proxy.rb << 'FORMULA'

            def install
              bin.install Dir["paw-proxy-*"].first || "paw-proxy" => "paw-proxy"
              resource("up").stage do
                bin.install Dir["up-*"].first || "up" => "up"
              end
            end

            def post_install
              ohai "Run 'sudo paw-proxy setup' to configure CA, DNS resolver, and LaunchAgent"
            end

            test do
              assert_match "paw-proxy", shell_output("#{bin}/paw-proxy version")
            end
          end
          FORMULA

      - name: Commit and push
        env:
          VERSION: ${{ steps.ver.outputs.version }}
          APP_SLUG: ${{ steps.app-token.outputs.app-slug }}
          USER_ID: ${{ steps.get-user-id.outputs.user-id }}
        run: |
          git config user.name "${APP_SLUG}[bot]"
          git config user.email "${USER_ID}+${APP_SLUG}[bot]@users.noreply.github.com"
          git add Formula/paw-proxy.rb
          git diff --staged --quiet || {
            git commit -m "chore: update paw-proxy to ${VERSION}"
            git push
          }
