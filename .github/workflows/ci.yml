# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - uses: golangci/golangci-lint-action@v4

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - run: go test -v -race ./...

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - run: |
          GOOS=darwin GOARCH=arm64 go build -o paw-proxy-arm64 ./cmd/paw-proxy
          GOOS=darwin GOARCH=amd64 go build -o paw-proxy-amd64 ./cmd/paw-proxy
          GOOS=darwin GOARCH=arm64 go build -o up-arm64 ./cmd/up
          GOOS=darwin GOARCH=amd64 go build -o up-amd64 ./cmd/up

  integration:
    runs-on: macos-14
    needs: [lint, test, build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Build
        run: |
          go build -o paw-proxy ./cmd/paw-proxy
          go build -o up ./cmd/up
      - name: Setup CA and resolver
        run: sudo ./paw-proxy setup
      - name: Prepare for daemon
        run: |
          sudo chmod 755 "$HOME/Library/Application Support/paw-proxy"
          launchctl unload ~/Library/LaunchAgents/dev.paw-proxy.plist 2>/dev/null || true
      - name: Start daemon
        run: |
          SOCK="$HOME/Library/Application Support/paw-proxy/paw-proxy.sock"
          sudo ./paw-proxy run > /tmp/daemon.log 2>&1 &
          DAEMON_PID=$!
          echo "Daemon PID: $DAEMON_PID"
          # Wait for socket to appear (up to 10s)
          for i in $(seq 1 20); do
            if [ -S "$SOCK" ]; then
              echo "Socket appeared after ${i}x0.5s"
              sudo chmod 777 "$SOCK"
              break
            fi
            # Check daemon is still alive
            if ! kill -0 $DAEMON_PID 2>/dev/null; then
              echo "Daemon crashed! Logs:"
              cat /tmp/daemon.log
              exit 1
            fi
            sleep 0.5
          done
          if [ ! -S "$SOCK" ]; then
            echo "Socket never appeared. Logs:"
            cat /tmp/daemon.log
            exit 1
          fi
      - name: Wait for daemon
        run: |
          for i in 1 2 3 4 5; do
            if curl -sf --unix-socket "$HOME/Library/Application Support/paw-proxy/paw-proxy.sock" http://unix/health; then
              echo "Daemon is ready"
              break
            fi
            if [ "$i" -eq 5 ]; then
              echo "Daemon never became healthy. Logs:"
              cat /tmp/daemon.log
              exit 1
            fi
            sleep 1
          done
      - name: Integration Tests
        run: ./integration-tests.sh
