# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

  # Enable re-triggering from auto-update-pr.yml workflow.
  # When a PR branch is updated using GITHUB_TOKEN, GitHub suppresses the
  # usual pull_request:synchronize event — so CI doesn't run automatically.
  # However, workflow_dispatch IS exempt from this suppression.
  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
      - uses: golangci/golangci-lint-action@v4

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
      - run: go test -v -race ./...

  vulncheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
      - run: go run golang.org/x/vuln/cmd/govulncheck@latest ./...

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
      - name: Build binaries
        run: |
          LDFLAGS="-X main.version=${GITHUB_REF_NAME:-dev} -X github.com/alexcatdad/paw-proxy/internal/api.Version=${GITHUB_REF_NAME:-dev}"
          GOOS=darwin GOARCH=arm64 go build -ldflags "$LDFLAGS" -o paw-proxy-arm64 ./cmd/paw-proxy
          GOOS=darwin GOARCH=amd64 go build -ldflags "$LDFLAGS" -o paw-proxy-amd64 ./cmd/paw-proxy
          GOOS=darwin GOARCH=arm64 go build -o up-arm64 ./cmd/up
          GOOS=darwin GOARCH=amd64 go build -o up-amd64 ./cmd/up

  integration:
    runs-on: macos-14
    needs: [lint, test, vulncheck, build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.24.13'
      - name: Build
        run: |
          go build -o paw-proxy ./cmd/paw-proxy
          go build -o up ./cmd/up
      - name: Lifecycle Tests (setup/uninstall)
        run: sudo ./lifecycle-tests.sh ./paw-proxy
      - name: Setup for runtime tests
        run: sudo ./paw-proxy setup
      - name: Start daemon
        run: |
          # In CI, launchd may not start the daemon reliably — start manually.
          # Bootout any launchd-managed instance first to free the sockets.
          sudo launchctl bootout "gui/$(id -u)/dev.paw-proxy" 2>/dev/null || true
          sudo ./paw-proxy run &
          DAEMON_PID=$!
          echo "DAEMON_PID=$DAEMON_PID" >> "$GITHUB_ENV"
          for i in 1 2 3 4 5 6 7 8 9 10; do
            if [ -S "$HOME/Library/Application Support/paw-proxy/paw-proxy.sock" ]; then
              echo "Socket appeared after ${i}s"
              break
            fi
            if ! kill -0 "$DAEMON_PID" 2>/dev/null; then
              echo "::error::Daemon process exited prematurely"
              cat "$HOME/Library/Logs/paw-proxy.log" 2>/dev/null || true
              exit 1
            fi
            sleep 1
          done
          sudo chown "$USER" "$HOME/Library/Application Support/paw-proxy/paw-proxy.sock"
          chmod 600 "$HOME/Library/Application Support/paw-proxy/paw-proxy.sock"
      - name: Wait for daemon
        run: |
          for i in 1 2 3 4 5; do
            if curl -sf --unix-socket "$HOME/Library/Application Support/paw-proxy/paw-proxy.sock" http://unix/health; then
              echo "Daemon is ready"
              break
            fi
            sleep 1
          done
      - name: Runtime Integration Tests
        run: ./integration-tests.sh
      - name: Uninstall Tests (cleanup)
        run: sudo ./paw-proxy uninstall --brew
      - name: Dump daemon logs on failure
        if: failure()
        run: |
          echo "=== Daemon log ==="
          cat "$HOME/Library/Logs/paw-proxy.log" 2>/dev/null || echo "No log file found"
