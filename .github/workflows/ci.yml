# .github/workflows/ci.yml
name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - uses: golangci/golangci-lint-action@v4

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - run: go test -v -race ./...

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - run: |
          GOOS=darwin GOARCH=arm64 go build -o paw-proxy-arm64 ./cmd/paw-proxy
          GOOS=darwin GOARCH=amd64 go build -o paw-proxy-amd64 ./cmd/paw-proxy
          GOOS=darwin GOARCH=arm64 go build -o up-arm64 ./cmd/up
          GOOS=darwin GOARCH=amd64 go build -o up-amd64 ./cmd/up

  integration:
    runs-on: macos-14
    needs: [lint, test, build]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: '1.22'
      - name: Setup login keychain for root
        run: |
          sudo -H security create-keychain -p "" /var/root/Library/Keychains/login.keychain-db || true
          sudo -H security default-keychain -s /var/root/Library/Keychains/login.keychain-db
          sudo -H security unlock-keychain -p "" /var/root/Library/Keychains/login.keychain-db
          sudo -H security list-keychains -s /var/root/Library/Keychains/login.keychain-db
      - name: Build
        run: |
          go build -o paw-proxy ./cmd/paw-proxy
          go build -o up ./cmd/up
      - name: Setup paw-proxy
        run: sudo -H ./paw-proxy setup
      - name: Wait for daemon
        run: sleep 2
      - name: Integration Tests
        run: ./integration-tests.sh
