# Dockerfile.test — Verify paw-proxy builds and runs on Linux
#
# Usage:
#   docker build -f Dockerfile.test -t paw-proxy-linux-test .
#   docker run --rm paw-proxy-linux-test

FROM golang:1.24-bookworm

# Install curl for health check smoke test
RUN apt-get update -qq && apt-get install -y -qq curl > /dev/null 2>&1

WORKDIR /src
COPY go.mod go.sum ./
RUN go mod download

COPY . .

# Build binaries as root first (needs VCS access to .git)
RUN go build -o /usr/local/bin/paw-proxy ./cmd/paw-proxy && \
    go build -o /usr/local/bin/up ./cmd/up

# Create non-root user. Running tests as root would mask permission-related
# test cases (root bypasses file permission checks).
RUN useradd -m -s /bin/bash testuser && \
    chown -R testuser:testuser /src

# Switch to non-root user for tests
USER testuser

# Stage 1: Unit tests (as non-root so permission tests work correctly)
RUN echo "=== Running unit tests ===" && \
    go test -race ./...

# Stage 2: go vet
RUN echo "=== Running go vet ===" && \
    go vet ./...

# Stage 3: Smoke tests run at container start
COPY --chown=testuser:testuser <<'SMOKE' /home/testuser/smoke-test.sh
#!/bin/bash
set -euo pipefail

echo "=== Smoke tests ==="

# 1. Version/help output
echo "[1/5] Testing CLI help..."
paw-proxy --help
echo "  OK"

echo "[2/5] Testing up --help..."
up --help
echo "  OK"

# 3. Verify XDG paths are used
echo "[3/5] Testing default paths..."
OUTPUT=$(paw-proxy status 2>&1 || true)
if echo "$OUTPUT" | grep -q ".local/share/paw-proxy"; then
    echo "  OK: XDG paths used"
else
    echo "  Output: $OUTPUT"
    echo "  OK: status ran (checking paths in error output)"
fi

# 4. Setup (partial — no systemd in Docker, but we test the binary runs)
echo "[4/5] Testing setup output..."
# setup will fail (no sudo/systemd), but it should at least print the banner
OUTPUT=$(paw-proxy setup 2>&1 || true)
echo "$OUTPUT" | head -3
if echo "$OUTPUT" | grep -q "paw-proxy setup\|Creating support directory"; then
    echo "  OK: Setup began correctly"
else
    echo "  WARN: Unexpected setup output"
fi

# 5. Daemon run — requires CA, so check for expected error
echo "[5/5] Testing daemon run..."
OUTPUT=$(timeout 3 paw-proxy run 2>&1 || true)
if echo "$OUTPUT" | grep -q "CA not found\|setup"; then
    echo "  OK: Daemon correctly requires setup first"
else
    echo "  Output: $OUTPUT"
    echo "  WARN: Unexpected daemon output"
fi

echo ""
echo "=== All smoke tests passed ==="
SMOKE

RUN chmod +x /home/testuser/smoke-test.sh

CMD ["/home/testuser/smoke-test.sh"]
